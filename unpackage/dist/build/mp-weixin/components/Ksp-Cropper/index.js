"use strict";const t=require("../../common/vendor.js"),e=t=>{t.wxsCallMethods||(t.wxsCallMethods=[]),t.wxsCallMethods.push("updateData")},i={props:{mode:{type:String,default:"free"},url:{type:String,default:""},width:{type:Number,default:200},height:{type:Number,default:200},maxWidth:{type:Number,default:1024},maxHeight:{type:Number,default:1024}},data:()=>({canvasId:Math.random().toString(36).slice(-6),real:{width:100,height:100},target:{width:100,height:100},body:{width:100,height:100},frame:{left:50,top:50,width:200,height:300},image:{left:20,top:20,width:300,height:400},rotate:0,transit:!1,modeValue:""}),methods:{imageLoad(e){t.index.getImageInfo({src:this.url,success:e=>{this.real.width=e.width,this.real.height=e.height,this.target={},t.index.createSelectorQuery().in(this).select(".body").boundingClientRect((t=>{this.body.width=t.width,this.body.height=t.height,this.init()})).exec()}})},init(){console.log("init-------"),this.modeValue=this.mode,this.rotate=0;var t=this.width/this.height,e=.7*this.body.width,i=.7*this.body.height;e/i>t?e=i*t:i=e/t;var h=(this.body.width-e)/2,a=(this.body.height-i)/2;this.frame={left:h,top:a,width:e,height:i},t=this.real.width/this.real.height,(e=this.frame.width)/(i=this.frame.height)>t?i=e/t:e=i*t,h=(this.frame.width-e)/2+this.frame.left,a=(this.frame.height-i)/2+this.frame.top,this.image={left:h,top:a,width:e,height:i}},async updateData(t){this.frame=t.frame,this.image=t.image,await this.$nextTick(),this.trimImage()},trimImage(){var t=this.frame.width/this.frame.height,e=.7*this.body.width,i=.7*this.body.height;e/i>t?e=i*t:i=e/t;var h=(this.body.width-e)/2,a=(this.body.height-i)/2,s=e/this.frame.width,r=this.frame.left-this.image.left,o=this.frame.top-this.image.top;this.frame={left:h,top:a,width:e,height:i},e=this.image.width*s,i=this.image.height*s,h=this.frame.left-r*s,a=this.frame.top-o*s,this.image={left:h,top:a,width:e,height:i},1!=s&&(this.transit=!0,setTimeout((()=>{this.transit=!1}),300))},rotateAngle(){this.rotate-=90;var t=this.image.height,e=this.image.width,i=this.image.left,h=this.image.top,a=t/e;t<this.frame.width&&(e=(t=this.frame.width)/a),e<this.frame.height&&(t=(e=this.frame.height)*a),i>this.frame.left&&(i=this.frame.left),h>this.frame.top&&(h=this.frame.top),i+t<this.frame.left+this.frame.width&&(i=this.frame.left+this.frame.width-t),h+e<this.frame.top+this.frame.height&&(h=this.frame.top+this.frame.height-e),this.image={left:i,top:h,width:t,height:e},this.transit=!0,setTimeout((()=>{this.transit=!1}),300)},onok(){this.cropWx()},oncancle(){this.$emit("cancel")},async cropWx(){var e=this.computeMatrix();this.target={width:e.tw,height:e.th};var i=await new Promise((e=>{t.index.createSelectorQuery().in(this).select(".canvas").fields({node:!0}).exec((t=>{console.log(t,"rst");var i=t[0].node;e(i)}))}));i.width=e.tw,i.height=e.th,t.index.showLoading({title:"处理中"}),await new Promise(((t,e)=>{setTimeout(t,200)}));var h=i.getContext("2d"),a=i.createImage();await new Promise(((t,e)=>{a.onload=t,a.onerror=e,a.src=this.url})),h.save(),h.rotate(this.rotate*Math.PI/180),h.drawImage(a,e.sx,e.sy,e.sw,e.sh,e.dx,e.dy,e.dw,e.dh),h.restore(),t.wx$1.canvasToTempFilePath({canvas:i,success:t=>{var e=t.tempFilePath;this.$emit("ok",{path:e})},complete:()=>{t.index.hideLoading()}})},async cropAppH5(){var e=this.computeMatrix();this.target={width:e.tw,height:e.th},t.index.showLoading({title:"处理中"}),await new Promise((t=>{setTimeout(t,200)}));var i=t.index.createCanvasContext(this.canvasId,this);i.save(),i.rotate(this.rotate*Math.PI/180),i.drawImage(this.url,e.sx,e.sy,e.sw,e.sh,e.dx,e.dy,e.dw,e.dh),i.restore(),await new Promise((t=>{i.draw(!1,t)})),t.index.canvasToTempFilePath({canvasId:this.canvasId,destWidth:e.tw,destHeight:e.th,success:t=>{t.tempFilePath},complete:()=>{t.index.hideLoading()}},this)},computeMatrix(){var t=this.width,e=this.height,i=this.image.width/this.real.width;this.rotate%180!=0&&(i=this.image.height/this.real.width),"fixed"!=this.mode&&(t=this.frame.width/i,e=this.frame.height/i);var h=t/e;t>this.maxWidth&&(e=(t=this.maxWidth)/h),e>this.maxHeight&&(t=(e=this.maxHeight)*h);var a=(this.frame.left-this.image.left)/i,s=(this.frame.top-this.image.top)/i,r=this.frame.width/i,o=this.frame.height/i,d=a+r/2,m=s+o/2;if(this.rotate%180!=0){var n=r;r=o,o=n}var g=this.rotate%360;if(g<0&&(g+=360),270==g){var l=d;d=w=this.real.width-m,m=l}180==g&&(d=w=this.real.width-d,m=l=this.real.height-m);if(90==g){var w=m;l=this.real.height-d;d=w,m=l}var f={x:0,y:0,w:t,h:e};return{tw:t,th:e,sx:a=d-r/2,sy:s=m-o/2,sw:r,sh:o,dx:(f=this.parseRect(f,-this.rotate)).x,dy:f.y,dw:f.w,dh:f.h}},parsePoint(t,e){var i={};return i.x=t.x*Math.cos(e*Math.PI/180)-t.y*Math.sin(e*Math.PI/180),i.y=t.y*Math.cos(e*Math.PI/180)+t.x*Math.sin(e*Math.PI/180),i},parseRect(t,e){var i=t.x,h=t.y,a=t.x+t.w,s=t.y+t.h,r=this.parsePoint({x:i,y:h},e),o=this.parsePoint({x:a,y:s},e),d={};return d.x=Math.min(r.x,o.x),d.y=Math.min(r.y,o.y),d.w=Math.abs(o.x-r.x),d.h=Math.abs(o.y-r.y),d},parseBlob(t){for(var e=t.split(","),i=e[0].match(/:(.*?);/)[1],h=atob(e[1]),a=h.length,s=new Uint8Array(a),r=0;r<a;r++)s[r]=h.charCodeAt(r);return(URL||webkitURL).createObjectURL(new Blob([s],{type:i}))}}};e(i);const h=t._export_sfc(i,[["render",function(e,i,h,a,s,r){return t.e({a:h.url},h.url?{b:s.target.width+"px",c:s.target.height+"px",d:s.transit?1:"",e:h.url,f:t.o(((...t)=>r.imageLoad&&r.imageLoad(...t))),g:s.transit?1:"",h:s.image,i:s.transit?1:"",j:h.url,k:s.transit?1:"",l:s.transit?1:"",m:s.frame,n:t.o(((...t)=>r.oncancle&&r.oncancle(...t))),o:t.o(((...t)=>r.rotateAngle&&r.rotateAngle(...t))),p:t.o(((...t)=>r.onok&&r.onok(...t))),q:s.modeValue,r:s.rotate}:{})}],["__scopeId","data-v-12f6b430"]]);wx.createComponent(h);
