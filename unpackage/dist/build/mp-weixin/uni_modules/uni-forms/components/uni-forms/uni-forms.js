"use strict";const e=require("./validate.js"),t=require("./utils.js"),a=require("../../../../common/vendor.js"),i={name:"uniForms",emits:["validate","submit"],options:{virtualHost:!0},props:{value:{type:Object,default:()=>null},modelValue:{type:Object,default:()=>null},model:{type:Object,default:()=>null},rules:{type:Object,default:()=>({})},errShowType:{type:String,default:"undertext"},validateTrigger:{type:String,default:"submit"},labelPosition:{type:String,default:"left"},labelWidth:{type:[String,Number],default:""},labelAlign:{type:String,default:"left"},border:{type:Boolean,default:!1}},provide(){return{uniForm:this}},data:()=>({formData:{},formRules:{}}),computed:{localData(){const e=this.model||this.modelValue||this.value;return e?t.deepCopy(e):{}}},watch:{rules:{handler:function(e,t){this.setRules(e)},deep:!0,immediate:!0}},created(){getApp().$vm.$.appContext.config.globalProperties.binddata||(getApp().$vm.$.appContext.config.globalProperties.binddata=function(e,t,a){if(a)this.$refs[a].setValue(e,t);else{let a;for(let e in this.$refs){const t=this.$refs[e];if(t&&t.$options&&"uniForms"===t.$options.name){a=t;break}}if(!a)return console.error("当前 uni-froms 组件缺少 ref 属性");a.setValue(e,t)}}),this.childrens=[],this.inputChildrens=[],this.setRules(this.rules)},methods:{setRules(t){this.formRules=Object.assign({},this.formRules,t),this.validator=new e.SchemaValidator(t)},setValue(e,a){let i=this.childrens.find((t=>t.name===e));return i?(this.formData[e]=t.getValue(e,a,this.formRules[e]&&this.formRules[e].rules||[]),i.onFieldChange(this.formData[e])):null},validate(e,t){return this.checkAll(this.formData,e,t)},validateField(e=[],a){e=[].concat(e);let i={};return this.childrens.forEach((a=>{const l=t.realName(a.name);-1!==e.indexOf(l)&&(i=Object.assign({},i,{[l]:this.formData[l]}))})),this.checkAll(i,[],a)},clearValidate(e=[]){e=[].concat(e),this.childrens.forEach((a=>{if(0===e.length)a.errMsg="";else{const i=t.realName(a.name);-1!==e.indexOf(i)&&(a.errMsg="")}}))},submit(e,t,a){for(let i in this.dataValue){this.childrens.find((e=>e.name===i))&&void 0===this.formData[i]&&(this.formData[i]=this._getValue(i,this.dataValue[i]))}return a||console.warn("submit 方法即将废弃，请使用validate方法代替！"),this.checkAll(this.formData,e,t,"submit")},async checkAll(e,a,i,l){if(!this.validator)return;let r,s=[];for(let h in e){const e=this.childrens.find((e=>t.realName(e.name)===h));e&&s.push(e)}i||"function"!=typeof a||(i=a),!i&&"function"!=typeof i&&Promise&&(r=new Promise(((e,t)=>{i=function(a,i){a?t(a):e(i)}})));let n=[],o=JSON.parse(JSON.stringify(e));for(let h in s){const e=s[h];let a=t.realName(e.name);const i=await e.onFieldChange(o[a]);if(i&&(n.push(i),"toast"===this.errShowType||"modal"===this.errShowType))break}Array.isArray(n)&&0===n.length&&(n=null),Array.isArray(a)&&a.forEach((e=>{let a=t.realName(e),i=t.getDataValue(e,this.localData);void 0!==i&&(o[a]=i)})),"submit"===l?this.$emit("submit",{detail:{value:o,errors:n}}):this.$emit("validate",n);let u={};return u=t.rawData(o,this.name),i&&"function"==typeof i&&i(n,u),r&&i?r:null},validateCheck(e){this.$emit("validate",e)},_getValue:t.getValue,_isRequiredField:t.isRequiredField,_setDataValue:t.setDataValue,_getDataValue:t.getDataValue,_realName:t.realName,_isRealName:t.isRealName,_isEqual:t.isEqual}};const l=a._export_sfc(i,[["render",function(e,t,a,i,l,r){return{}}]]);wx.createComponent(l);
