"use strict";const d=require("../../../../common/vendor.js"),y="chooseAndUploadFile:ok",p="chooseAndUploadFile:fail";function x(e){const{count:t,sizeType:o=["original","compressed"],sourceType:n=["album","camera"],extension:s}=e;return new Promise((r,c)=>{d.index.chooseImage({count:t,sizeType:o,sourceType:n,extension:s,success(u){r(m(u,"image"))},fail(u){c({errMsg:u.errMsg.replace("chooseImage:fail",p)})}})})}function M(e){const{camera:t,compressed:o,maxDuration:n,sourceType:s=["album","camera"],extension:r}=e;return new Promise((c,u)=>{d.index.chooseVideo({camera:t,compressed:o,maxDuration:n,sourceType:s,extension:r,success(a){const{tempFilePath:l,duration:f,size:i,height:g,width:F}=a;c(m({errMsg:"chooseVideo:ok",tempFilePaths:[l],tempFiles:[{name:a.tempFile&&a.tempFile.name||"",path:l,size:i,type:a.tempFile&&a.tempFile.type||"",width:F,height:g,duration:f,fileType:"video",cloudPath:""}]},"video"))},fail(a){u({errMsg:a.errMsg.replace("chooseVideo:fail",p)})}})})}function P(e){const{count:t,extension:o}=e;return new Promise((n,s)=>{let r=d.index.chooseFile;if(typeof d.wx$1<"u"&&typeof d.wx$1.chooseMessageFile=="function"&&(r=d.wx$1.chooseMessageFile),typeof r!="function")return s({errMsg:p+" 请指定 type 类型，该平台仅支持选择 image 或 video。"});r({type:"all",count:t,extension:o,success(c){n(m(c))},fail(c){s({errMsg:c.errMsg.replace("chooseFile:fail",p)})}})})}function m(e,t){return e.tempFiles.forEach((o,n)=>{o.name||(o.name=o.path.substring(o.path.lastIndexOf("/")+1)),t&&(o.fileType=t),o.cloudPath=Date.now()+"_"+n+o.name.substring(o.name.lastIndexOf("."))}),e.tempFilePaths||(e.tempFilePaths=e.tempFiles.map(o=>o.path)),e}function w(e,t=5,o){e=JSON.parse(JSON.stringify(e));const n=e.length;let s=0,r=this;return new Promise(c=>{for(;s<t;)u();function u(){let a=s++;if(a>=n){!e.find(i=>!i.url&&!i.errMsg)&&c(e);return}const l=e[a],f=r.files.findIndex(i=>i.uuid===l.uuid);l.url="",delete l.errMsg,d.Ds.uploadFile({filePath:l.path,cloudPath:l.cloudPath,fileType:l.fileType,onUploadProgress:i=>{i.index=f,o&&o(i)}}).then(i=>{l.url=i.fileID,l.index=f,a<n&&u()}).catch(i=>{l.errMsg=i.errMsg||i.message,l.index=f,a<n&&u()})}})}function h(e,{onChooseFile:t,onUploadProgress:o}){return e.then(n=>{if(t){const s=t(n);if(typeof s<"u")return Promise.resolve(s).then(r=>typeof r>"u"?n:r)}return n}).then(n=>n===!1?{errMsg:y,tempFilePaths:[],tempFiles:[]}:n)}function I(e={type:"all"}){return e.type==="image"?h(x(e),e):e.type==="video"?h(M(e),e):h(P(e),e)}exports.chooseAndUploadFile=I;exports.uploadCloudFiles=w;
